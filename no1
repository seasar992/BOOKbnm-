%gui qt
#プロット関係のライブラリ
import pyqtgraph as pg
from pyqtgraph.Qt import QtCore, QtGui
import numpy as np
import serial
import sys

class PlotWindow:
    def __init__(self):
        #プロット初期設定
        self.win=pg.GraphicsWindow()
        self.win.setWindowTitle(u"リアルタイムプロット")
        self.plt=self.win.addPlot() #プロットのビジュアル関係
        self.plt.setYRange(-1,70000)    #y軸の上限、下限の設定
        self.curve=self.plt.plot()  #プロットデータを入れる場所
        
        self.ser = serial.Serial(port="COM3",baudrate=115200)
      
        #アップデート時間設定
        self.timer=QtCore.QTimer()
        self.timer.timeout.connect(self.update)
        self.timer.start(10)    #10msごとにupdateを呼び出し

        #UART受信データ(data)
        self.data=[0]

    def update(self):            
        #データの読み取り
        ReceData = self.ser.read(2)
        #16進数2桁のデータ2つを一気にデコード
        ReceData = np.frombuffer(ReceData,dtype=np.uint8)

        self.data.append(256*ReceData[0]+ReceData[1])
        self.curve.setData(self.data)   #プロットデータを格納
        #self.ser.write(bytearray([70])) #デバック用送信器

if __name__=="__main__":
    plotwin=PlotWindow()
    if (sys.flags.interactive!=1) or not hasattr(QtCore, 'PYQT_VERSION'):
        QtGui.QApplication.instance().exec_()
   
